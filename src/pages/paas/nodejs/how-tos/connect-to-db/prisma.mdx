import Layout from "@/components/Layout";
import Button from "@/components/Common/button";
import Section from "@/components/Common/section";
import Alert from "@/components/Common/alert";
import Tabs from "@/components/Common/tab";
import Step from "@/components/Common/step";
import Card from "@/components/Common/card";
import Important from "@/components/Common/important";
import Highlight from "@/components/Common/highlight";
import Link from "next/link";
import NextPage from "@/components/Common/nextpage";

import Head from "next/head";

<Layout>
<Head>
<title>مستندات اتصال به دیتابیس با Prisma در NodeJS - لیارا</title>
<meta property="og:title" content="مستندات خدمات رایانش ابری لیارا" />
<meta property="og:description" content="مستندات مربوط به اتصال به دیتابیس‌ با Prisma ORM در پلتفرم NodeJS در لیارا"  />
</Head>
# اتصال به دیتابیس با استفاده از Prisma در برنامه‌های NodeJS 

<hr className="mb-2" />

{/* <video
    src="https://media.liara.ir/prisma/prisma.mp4"
    controls="controls"
    className="block w-full"
    width="100%"
/>
<div className="h-2" />
<Alert variant="info">
<p>
پروژه و کدهای مورد استفاده در ویدیوی فوق در <a className="text-[#2196f3] " href="https://github.com/liara-cloud/nodejs-getting-started/tree/prisma">اینجا</a> قابل مشاهده و دسترسی است.
</p>
</Alert>
<div className="h-2" /> */}

<a href="https://www.prisma.io/" target="_blank" className="text-[#2196f3]" rel="noopener">Prisma</a> یک ORM متن‌باز و شامل سه بخش زیر است:‌

<div className="h-2" />
<ul>
<li><b>Prisma Client</b>: یک کوئری‌ساز auto-generated و type-safe برای <a href="https://liara.ir/landing/%D9%87%D8%A7%D8%B3%D8%AA-%D9%86%D9%88%D8%AF-%D8%AC%DB%8C-%D8%A7%D8%B3-node/" className="text-[#2196f3]">NodeJS</a> و <a href="/paas/nodejs/how-tos/use-type-script/" className="text-[#2196f3]">TypeScript</a></li>
<li><b>Prisma Migrate</b>: سیستم مدیریت migrationها در دیتابیس</li>
<li><b>Prisma Studio</b>: رابط گرافیکی برای مشاهده و ویرایش داده‌ها در دیتابیس</li>
</ul>
<div className="h-2" />

Prisma Client می‌تواند در هر برنامه‌ی NodeJS یا TypeScript مورد استفاده قرار گیرد، از جمله برنامه‌های serverless و میکروسرویس‌ها. 
در ادامه، به نحوه استفاده از این ORM با <a href="https://liara.ir/landing/%D9%87%D8%A7%D8%B3%D8%AA-%D8%A7%D8%A8%D8%B1%DB%8C-postgre-sql/" className="text-[#2196f3]">دیتابیس PostgreSQL</a> و نحوه استقرار برنامه‌های مبتنی بر آن در لیارا، پرداخته شده است. 
<div className="h-2" />

برای استفاده از این ORM، در ابتدا باید با اجرای دستور زیر در خط فرمان سیستم خود، فایل‌های Migration را ایجاد کنید:

<Step  steps={[
    {
    step: "۱",
    content: (
        <>
            <h3>ایجاد یک پروژه NodeJS</h3>   
            <p>
                با اجرای دستورات زیر، محیط پروژه NodeJS خود را ایجاد کنید:
            </p>
            <div className="h-2" />
            <div dir='ltr'>
                <Highlight className="bash">
                    {`mkdir prisma-liara
cd prisma-liara
npm init -y`}
                </Highlight>
            </div>
            <div className="h-2" />
        </>
    )
    },
    {
    step: "۲",
    content: (
        <>
            <h3>نصب پکیج‌های مورد نیاز</h3>   
            <p>
               با اجرای دستورات زیر، تمامی پکیج‌ها و ابزارهای مورد نیاز برنامه را، نصب کنید:
            </p>
            <div className="h-2" />
            <div dir='ltr'>
                <Highlight className="bash">
                    {`npm install prisma @types/node @types/express typescript --save-dev
npm install @prisma/client @prisma/adapter-pg @faker-js/faker express`}
                </Highlight>
            </div>
            <div className="h-2" />
        </>
    )
    },
    {
    step: "۳",
    content: (
        <>
            <h3>راه‌اندازی و پیکربندی Prisma</h3>   
            <p>
                با اجرای دستور زیر، Prisma را در برنامه خود، راه‌اندازی کنید:
            </p>
            <div className="h-2" />
            <div dir='ltr'>
                <Highlight className="bash">
                    {`npx prisma init --datasource-provider postgresql`}
                </Highlight>
            </div>
            <div className="h-2" />
            <p>
            دستور فوق، چندین فایل مرتبط با prisma را در پروژه‌تان، ایجاد می‌کند.
            درون فایل <Important>env.</Important>، متغیر <Important>DATABASE_URL</Important> را مشابه زیر، مقداردهی کنید:
            </p>
            <div className="h-2" />
            <div dir='ltr'>
                <Highlight className="bash">
                    {`DATABASE_URL=postgresql://USERNAME:PASSWORD@HOST:PORT/postgres`}
                </Highlight>
            </div>
            <Alert variant="info">
                <p>
                    مقدار متغیر فوق را با اطلاعات دیتابیس PostgreSQL خود، آپدیت کنید.
                </p>
            </Alert>
            <div className="h-2" />
            <p>
                در ادامه، قطعه کد زیر را جایگزین کد فعلی فایل <Important>prisma/schema.prisma</Important> کنید:
            </p>
            <div className="h-2" />
            <div dir='ltr'>
                <Highlight className="prisma">
                    {`generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id    Int    @id @default(autoincrement())
  email String @unique
  name  String
}`}
                </Highlight>
            </div>
            <div className="h-2" />
        </>
    )
    },
    {
    step: "۴",
    content: (
        <>
            <h3>ایجاد migrationها</h3>   
            <p>
               با اجرای دستور زیر، migrationها را قبل از استقرار برنامه، تولید کنید:
            </p>
            <div className="h-2" />
            <div dir='ltr'>
                <Highlight className="bash">
                    {`npx prisma migrate dev --name init`}
                </Highlight>
            </div>
            <div className="h-2" />
        </>
    )
    },
    {
    step: "۵",
    content: (
        <>
            <h3>ایجاد و پیکربندی‌ برنامه اصلی</h3>   
            <p>
                مسیر <Important>src/server.ts</Important> را ایجاد کنید و قطعه کد زیر را، درون آن، قرار دهید: 
            </p>
            <div className="h-2" />
            <div dir='ltr'>
                <Highlight className="node">
                    {`import express, { Request, Response } from "express";
import { PrismaClient } from "@prisma/client";
import { PrismaPg } from "@prisma/adapter-pg";
import { faker } from "@faker-js/faker";
import dotenv from "dotenv";

dotenv.config();

const adapter = new PrismaPg({
  connectionString: process.env.DATABASE_URL!,
});

const prisma = new PrismaClient({ adapter });
const app = express();

function createRandomUser() {
  const firstName = faker.person.firstName();
  const lastName = faker.person.lastName();
  const email = faker.internet.email({ firstName, lastName });

  return {
    name: \`\${firstName} \${lastName}\`,
    email,
  };
}

app.get("/", async (req: Request, res: Response) => {
  try {
    const randomUser = createRandomUser();
    const user = await prisma.user.create({
      data: randomUser,
    });

    res.json({
      success: true,
      user,
    });
  } catch (err: any) {
    console.error(err);
    res.status(500).json({
      success: false,
      error: "Internal Server Error",
    });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(\`Server running on port \${PORT}\`);
});
`}
                </Highlight>
            </div>
            <div className="h-2" />
            <p>
                در مسیر اصلی پروژه، یک فایل به نام <Important>tsconfig.json</Important> ایجاد کنید و قطعه کد زیر را درون آن، قرار دهید:
            </p>

            <div className="h-2" />
            <div dir='ltr'>
                <Highlight className="json">
                    {`{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS",
    "rootDir": "./",
    "outDir": "dist",
    "esModuleInterop": true,
    "strict": true,
    "skipLibCheck": true
  },
  "include": ["src/**/*.ts", "prisma.config.ts"]
}`}
                </Highlight>
            </div>
            <div className="h-2" />            

        </>
    )
    },
    {
    step: "۶",
    content: (
        <>
            <h3>آماده‌سازی برنامه برای استقرار</h3>   
            <p>
                بخش <Important>scripts</Important> را مانند زیر در فایل <Important>package.json</Important> تغییر دهید: 
            </p>
            <div className="h-2" />
            <div dir='ltr'>
                <Highlight className="json">
                    {`"scripts": {
    "build": "npx prisma generate && tsc",
    "start": "node dist/src/server.js"
},`}
                </Highlight>
            </div>
            <div className="h-2" />
            <p>
                همچنین، یک فایل در مسیر اصلی پروژه، به نام <Important>liara_pre_start.sh</Important> ایجاد کنید و قطعه کد زیر را، درون آن، قرار دهید:
            </p>
            <div className="h-2" />
            <div dir='ltr'>
            <Highlight className="bash">
                {`npx prisma migrate deploy`}
            </Highlight>
            </div>
            <div className="h-2" />
        </>
    )
    },
    {
    step: "۷",
    content: (
        <>
            <h3>استقرار برنامه در لیارا</h3>   
            <p>
                متغیر <Important>DATABASE_URL</Important> تعریف شده در فایل <Important>env.</Important> را طبق مستندات <a href="/paas/details/envs" className="text-[#2196f3] ">تنظیم متغیرهای محیطی در برنامه</a>، به برنامه خود اضافه کنید. 
            </p>
            <div className="h-2" />

            <Alert variant="info">
                <p>
                    در صورت استفاده از <a href="https://liara.ir/landing/%D9%87%D8%A7%D8%B3%D8%AA-%D8%A7%D8%A8%D8%B1%DB%8C-postgre-sql/" className="text-[#2196f3] ">دیتابیس PostgreSQL لیارا</a>، توصیه می‌شود هم برنامه و هم دیتابیس را در یک <a href="/paas/details/private-network" className="text-[#2196f3] ">شبکه خصوصی</a> قرار دهید و برای ایجاد اتصال ایمن و مطمئن از URI شبکه خصوصی دیتابیس استفاده کنید.
                </p>
            </Alert>

            <div className="h-2" />
            <p>
                در نهایت، طبق <a href="/paas/nodejs/how-tos/create-app/" className="text-[#2196f3]">مستندات ساخت برنامه NodeJS</a>، یک برنامه NodeJS ایجاد کنید و با اجرای دستور زیر با استفاده از <a href="/references/cli/about/" className="text-[#2196f3]">Liara CLI</a>، برنامه خود را در لیارا، مستقر کنید:
            </p>

            <div className="h-2" />
            <div dir='ltr'>
            <Highlight className="bash">
                {`liara deploy --port 3000`}
            </Highlight>
            </div>
            <div className="h-2" />
        </>
    )
    },
]}
/>

<br />
<Alert variant='info'>
    <p>
        یک پروژه NodeJS مبتنی بر Prisma در <a href="https://github.com/liara-cloud/nodejs-getting-started/tree/prisma" className="text-[#2196f3]">گیت‌هاب لیارا</a> وجود دارد که می‌توانید از آن، استفاده کنید.
    </p>
</Alert>

</Layout>